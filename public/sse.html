<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <script type="text/javascript" src="EventEmitter2.js"></script>
  <script type="text/javascript" src="util.js"></script>
  <script type="text/javascript" src="array-proxy.js"></script>
  <script src="http://fb.me/react-0.12.2.js"></script>
  <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
  <script type="text/javascript">
(function() {
  function LogApp() {
  
    var _id = util.guid();
    var _messages = ArrayProxy.proxy([], messagesChangeHandler.bind(this)); // Private state
    var _maxWindowLength = 250;
    var _query = '';
    var _isListening = true;
    
    Object.defineProperty(this, 'id', {
      value: _id,
      enumerable: true,
      writable: false
    });
    
    Object.defineProperty(this, 'query', {
      get: function() { return _query; },
      set: function(q) {
        _query = q;
        this.emit('query');
      },
      enumerable: true
    });
    
    Object.defineProperty(this, 'messages', {
      get: function() { return _messages; },
      set: function(ms) {
        if(!Array.isArray(ms)) { throw new TypeError('Must be an Array'); }
        _messages = ArrayProxy.proxy(
          truncateInPlace(ms, _maxWindowLength),
          messagesChangeHandler.bind(this)
        );
        //this.emit('messages:set', _messages);
        this.emit('messages:changed');
      },
      enumerable: true
    });
    
    function truncateInPlace(arr, maxLength, silent /* If true, subverts proxy to not fire change event */) {
      maxLength = maxLength || _maxWindowLength;
      silent = !!silent;
      // Call the Array.prototype version, not the proxy in silent mode
      var splice = silent ? Array.prototype.splice : arr.splice;
      // splice, unlike, slice modifies in-place
      splice.call(
        arr,
        maxLength, // start
        arr.length - (Math.min(maxLength, arr.length) - 1) // number to delete
      );
      return arr;        
    }
    
    Object.defineProperty(this, 'maxWindowLength', {
      get: function() { return _maxWindowLength; },
      set: function(value) {
        if('number' !== typeof value || value < 1) { throw new TypeError('maxWindowLength must be a non-zero, positive number'); }
        if(value < _maxWindowLength) {
          truncateInPlace(this.messages, value);
        }
        _maxWindowLength = value;
        this.emit('maxwindowlength:changed');
      },
      enumerable: true
    });
    
    function messagesChangeHandler(e, args) {
      console.log(e.type);
      truncateInPlace(_messages, _maxWindowLength, true);
      var messages = args;
      switch(e.type) {
        case 'push':
        case 'unshift': // unshift allows passing multiple arguments
          this.emit('messages:changed', Array.prototype.slice.call(arguments, 1));  // Arguments less the event
          break;
        case 'concat':
        case 'join':
        case 'slice': // None of these changes the array
          break;
        default:
          this.emit('messages:changed');
          break;
      }
    }
    
    Object.defineProperty(this, 'isListening', {
      get: function() { return _isListening; },
      set: function(value) {
        _query = value;
        this.emit('islistening:changed');
      },
      enumerable: true
    });
  }
  LogApp.prototype = Object.create(EventEmitter2.prototype);
  
  // FIXME: This is mixing concerns
  LogApp.prototype.initializeStream = function(url) {
    var that = this;
    
    // FIXME: Is this the right place to do this?
    var that = this;
    url = (url || '/stream/') + this.id;
    var source = new EventSource(url);

    source.addEventListener('log', function(e) {
      var msg = JSON.parse(e.data);
      that.messages.unshift(msg);
    });

    source.addEventListener('batch', function(e) {
      var batch = JSON.parse(e.data);
      that.messages = batch;
    });

    source.addEventListener('open', function(e) {
      console.log('Opened connection');
    });

    source.onerror = function(e) {
      console.dir(e);
      this.close();
    }
  }
  LogApp.prototype.query = function(qs) {
    console.log(qs);
  }
  
  /****************************************/
  var app = new LogApp(); 
  window.app = app; // DEBUG
  console.log('New app with id ' + app.id);
  
  app.on('query', function() { console.log(this.query);});
  
  // FIXME: Get a real UI framework to do the rendering. This is awful.
  
  var messageChangeHandler = (function(msgs) {
    renderMessages(this.messages);
  }).bind(app);
   
  //app.on('messages:set', messageChangeHandler);
  app.on('messages:changed', messageChangeHandler);
  
  //app.on('islistening:changed', function(e) { app.initializeStream(); });
  
  function renderMessages(msgs) {
    var body = document.querySelector('table#Logs > tbody');
    var table = body.parentNode;
    table.removeChild(body);
    body = document.createElement('tbody');
    for(var i = 0; i < msgs.length; i++) {
      var msg = msgs[i];
      body.appendChild(renderRow(msg));
    }
    table.appendChild(body);
    
    function renderRow(msg) {
      var row = document.createElement('tr');
      var time = document.createElement('td'),
          host = document.createElement('td'),
          severity = document.createElement('td'),
          message = document.createElement('td');
      time.appendChild(document.createTextNode(msg.time));
      host.appendChild(document.createTextNode(msg.host));
      severity.appendChild(document.createTextNode(msg.severity));
      message.appendChild(document.createTextNode(msg.message));
      row.appendChild(time);
      row.appendChild(host);
      row.appendChild(severity);
      row.appendChild(message);
      return row;
    }
  }
  
  

  document.addEventListener('DOMContentLoaded', function(e) {
    app.initializeStream();
    
    var form = document.querySelector('form#Search');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      app.query = form.querySelector('input').value;
    });
  }, false);
})();
  </script>
  <style type="text/css">
body {
  font-family: Helvetica, sans-serif;
  padding: 2em 1em;
}
table#Logs {
  width: 100%;
  border-collapse: collapse;
}
td, th {
  text-align: left;
  padding: 0.25rem 0.5rem;
  border: solid 1px #ccc;
}
  </style>
</head>
<body>
  <form id="Search">
    <input type="text" name="q"/>
    <button>Search</button>
  </form>
  <table id="Logs">
    <thead>
      <tr>
        <th>Time</th>
        <th>Host</th>
        <th>Severity</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
    
    </tbody>
  </table>
</body>
</html>
