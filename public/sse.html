<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <script type="text/javascript" src="EventEmitter2.js"></script>
  <script type="text/javascript">
(function() {
  function LogApp() {
    var guid = (function() {
      function s4() {
        return Math.floor((1 + Math.random()) * 0x10000).toString(16).substring(1);
      }
      return function() {
        return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
      };
    })();
  
    this.id = guid();
    this.messages = [];
    this.query = '';
  }
  //LogApp.prototype = Object.clone(EventEmitter.prototype);
  LogApp.prototype = Object.create(EventEmitter2.prototype);
  LogApp.prototype.initializeStream = function(url) {
    var that = this;
    url = (url || '/stream/') + this.id;
    var source = new EventSource(url);

    source.addEventListener('log', function(e) {
      var msg = JSON.parse(e.data);
      //console.dir(msg);
      that.emit('log:received', msg);
    }, false);

    source.addEventListener('open', function(e) {
      console.log('Opened connection');
    }, false);

    source.onerror = function(e) {
      console.dir(e);
      this.close();
      throw new Error();  
    }
  }
  
  /****************************************/
  var app = new LogApp();
  console.log('New app with id ' + app.id);
  
  app.on('log:received', function(msg) {
    var body = document.querySelector('table#Logs > tbody');
    var row = document.createElement('tr');
    var time = document.createElement('td'),
        host = document.createElement('td'),
        severity = document.createElement('td'),
        message = document.createElement('td');
    time.appendChild(document.createTextNode(msg.time));
    host.appendChild(document.createTextNode(msg.host));
    severity.appendChild(document.createTextNode(msg.severity));
    message.appendChild(document.createTextNode(msg.message));
    row.appendChild(time);
    row.appendChild(host);
    row.appendChild(severity);
    row.appendChild(message);
    body.insertBefore(row, body.firstChild);
  });

  document.addEventListener('DOMContentLoaded', function(e) {
    app.initializeStream();
  }, false);
})();
  </script>
  <style type="text/css">
body {
  font-family: Helvetica, sans-serif;
  padding: 2em 1em;
}
table#Logs {
  width: 100%;
  border-collapse: collapse;
}
td, th {
  text-align: left;
  padding: 0.25rem 0.5rem;
  border: solid 1px #ccc;
}
  </style>
</head>
<body>
  <table id="Logs">
    <thead>
      <tr>
        <th>Time</th>
        <th>Host</th>
        <th>Severity</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
    
    </tbody>
  </table>
</body>
</html>
