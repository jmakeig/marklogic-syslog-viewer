<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <script type="text/javascript" src="lib/number-tolocalestring.js"></script>
  <script type="text/javascript" src="EventEmitter2.js"></script>
  <script type="text/javascript" src="util.js"></script>
  <script type="text/javascript" src="array-proxy.js"></script>
  <!-- <script src="http://fb.me/react-0.12.2.js"></script> -->
  <!-- <script src="http://fb.me/JSXTransformer-0.12.2.js"></script> -->
  <script type="text/javascript" src="lib/moment.js"></script>
  <script type="text/javascript">
(function() {
  function LogApp() {
  
    var _id = util.guid();
    var _messages = ArrayProxy.proxy([], messagesChangeHandler.bind(this));
    var _maxWindowLength = 250;
    var _query = '';
    var _isListening = true;
    
    Object.defineProperty(this, 'id', {
      value: _id,
      enumerable: true,
      writable: false
    });
    
    Object.defineProperty(this, 'query', {
      get: function() { return _query; },
      set: function(q) {
        _query = q;
        this.emit('query:changed');
      },
      enumerable: true
    });
    
    Object.defineProperty(this, 'messages', {
      get: function() { return _messages; },
      set: function(ms) {
        if(!Array.isArray(ms)) { throw new TypeError('Must be an Array'); }
        _messages = ArrayProxy.proxy(
          truncateInPlace(ms, _maxWindowLength),
          messagesChangeHandler.bind(this)
        );
        //this.emit('messages:set', _messages);
        this.emit('messages:changed');
      },
      enumerable: true
    });
    
    function truncateInPlace(arr, maxLength, silent /* If true, subverts proxy to not fire change event */) {
      maxLength = maxLength || _maxWindowLength;
      silent = !!silent;
      // Call the Array.prototype version, not the proxy in silent mode
      var splice = silent ? Array.prototype.splice : arr.splice;
      // splice, unlike, slice modifies in-place
      splice.call(
        arr,
        maxLength, // start
        arr.length - (Math.min(maxLength, arr.length) - 1) // number to delete
      );
      // Need to sort in the case where delivery is delayed. 
      // Message timestamps will still reflect the original log time.
      Array.prototype.sort.call(arr, function(a, b) {
        var a = new Date(a.time);
        var b = new Date(b.time);
        // Reverse order
        return b - a;
      });
      return arr;        
    }
    
    Object.defineProperty(this, 'maxWindowLength', {
      get: function() { return _maxWindowLength; },
      set: function(value) {
        if('number' !== typeof value || value < 1) { throw new TypeError('maxWindowLength must be a non-zero, positive number'); }
        if(value < _maxWindowLength) {
          truncateInPlace(this.messages, value);
        }
        _maxWindowLength = value;
        this.emit('maxwindowlength:changed');
      },
      enumerable: true
    });
    
    function messagesChangeHandler(e, args) {
      console.log(e.type);
      truncateInPlace(_messages, _maxWindowLength, true);
      var messages = args;
      switch(e.type) {
        case 'push':
        case 'unshift': // unshift allows passing multiple arguments
          this.emit('messages:changed', Array.prototype.slice.call(arguments, 1));  // Arguments less the event
          break;
        case 'concat':
        case 'join':
        case 'slice': // None of these changes the array
          break;
        default:
          this.emit('messages:changed');
          break;
      }
      console.log(this.messages.length + ' total. Latest: ' + this.messages[0].message.time);
    }
    
    Object.defineProperty(this, 'isListening', {
      get: function() { return _isListening; },
      set: function(value) {
        _isListening = value;
        this.emit('islistening:changed');
      },
      enumerable: true
    });
  }
  LogApp.prototype = Object.create(EventEmitter2.prototype);
  
  /****************************************/
  function LogController(model) {
    if(null === model || 'undefined' === typeof model) { throw new TypeError(); }
    
    this.model = model;
    this.eventSource = null;
    
    function messageChangeHandler(msgs) {
      renderMessages(this.model.messages, window.navigator.userLanguage || window.navigator.language);
    };
   
    model.on('messages:changed', messageChangeHandler.bind(this));

    function queryChangeHandler(query) {
      this.eventSource.close();
      this.initializeStream();
    }    
    model.on('query:changed', queryChangeHandler.bind(this));
  }
  // FIXME: This is mixing concerns
  LogController.prototype.initializeStream = function() {
    var url = '/stream/' + this.model.id + 
      (this.model.query ? '?q=' + encodeURIComponent(this.model.query) : '');
    //console.log(url);
    this.eventSource = new EventSource(url);
    
    var that = this;
    var source = this.eventSource;
    
    source.addEventListener('log', function(e) {
      var msg = JSON.parse(e.data);
      that.model.messages.unshift(msg);
    });

    source.addEventListener('batch', function(e) {
      var batch = JSON.parse(e.data);
      that.model.messages = batch;
    });

    source.addEventListener('open', function(e) {
      //console.dir(this);
      console.log('Listening on ' + this.url);
    });

    source.onerror = function(e) {
      console.dir(e);
      this.close();
    }
  }
  
  /****************************************/
  var model = new LogApp(); 
  window.model = model; // DEBUG
  console.log('New model with id ' + model.id);
  
  var controller = new LogController(model);
  
  // FIXME: Get a real UI framework to do the rendering. This is awful.
  
  function renderMessages(msgs, locale) {
    var body = document.querySelector('table#Logs > tbody');
    var table = body.parentNode;
    table.removeChild(body);
    body = document.createElement('tbody');
    for(var i = 0; i < msgs.length; i++) {
      var msg = msgs[i];
      body.appendChild(renderRow(msg, msgs[i + 1]));
    }
    table.appendChild(body);
    
    function renderRow(msg, nextMsg, locale) {
      var TIMESTAMP = 'HH:mm:ss, YYYY-MM-DD';
      var row = document.createElement('tr');
      var time = document.createElement('td'),
          diff = document.createElement('td'),
          sender = document.createElement('td'),
          host = document.createElement('td'),
          severity = document.createElement('td'),
          message = document.createElement('td');
      if(msg.severity) { severity.classList.add('severity', msg.severity.toLowerCase()); }
      severity.appendChild(document.createTextNode(msg.severity));
      severity.setAttribute('data-severity', msg.severity);
      severity.setAttribute('title', msg.severity);
      var currentTime = moment(msg.time);
      var diffStr = '';
      if(nextMsg && nextMsg.time) {
        diffStr = moment.duration(
          currentTime.diff(
            moment(nextMsg.time)
          )
        ).asSeconds().toLocaleString(locale);
      }
      diff.appendChild(document.createTextNode(diffStr));
      diff.classList.add('diff');
      time.appendChild(document.createTextNode(currentTime.format(TIMESTAMP))); // .SSS for fractional seconds
      time.setAttribute('data-time', currentTime.format());
      time.classList.add('time');
      sender.appendChild(document.createTextNode(msg.sender));
      sender.classList.add('sender');
      host.appendChild(document.createTextNode(msg.host));
      host.classList.add('host');
      message.appendChild(document.createTextNode(msg.message));
      message.classList.add('message');
      row.appendChild(severity);
      row.appendChild(time);
      row.appendChild(diff);
      row.appendChild(sender);
      row.appendChild(host);
      row.appendChild(message);
      // row.classList.add('flash'); // Since we're redrawing each time, no way to figure out the new ones
      return row;
    }
  }

  document.addEventListener('DOMContentLoaded', function(e) {
    controller.initializeStream();
    
    var form = document.querySelector('form#Search');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      model.query = form.querySelector('input').value;
    });
  }, false);
})();
  </script>
  <link type="text/css" rel="stylesheet" href="app.css"></link>
</head>
<body>
  <header>
    <h1>Syslog for Humans</h1>
  </header>
  <nav>
    <form id="Search">
      <div class="control search"><input type="text" name="q" /></div>
      <div class="control submit"><button>Search</button></div>
    </form>
    <form id="Facets">
      <div class="facet hosts">
        <h3>Hosts</h3>
        <ol>
          <li><input type="checkbox"/> ex1.example.com (15,839)</li>
          <li><input type="checkbox"/> qa.some-other.com (4,402)</li>
          <li><input type="checkbox"/> ex2.example.com (189)</li>
          <li><input type="checkbox"/> ex3.example.com (5)</li>
          <li><input type="checkbox"/> ex4.example.com (0)</li>
        </ol>
      </div>
      <div class="facet senders">
        <h3>Sender</h3>
        <ol>
          <li><input type="checkbox"/> MarkLogic</li>
          <li><input type="checkbox"/> Node.js</li>
        </ol>
      </div>
      <div class="facet severities">
        <h3>Severity</h3>
        <ol>
          <li><input type="checkbox"/> Critical</li>
          <li><input type="checkbox"/> Alert</li>
          <li><input type="checkbox"/> Error</li>
          <li><input type="checkbox"/> Notice</li>
          <li><input type="checkbox"/> Info</li>
          <li><input type="checkbox"/> Debug</li>
        </ol>
      </div>
      <!--<div class="facet date-range">
      
      </div>-->
    </form>
    <table id="Logs">
      <caption>Logs</caption>
      <colgroup>
        <col class="severity"/>
        <col class="time"/>
        <col class="diff"/>
        <col class="sender"/>
        <col class="host"/>
        <col class="message"/>
      </colgroup>
      <thead>
        <tr>
          <th class="severity"></th>
          <th class="time">Time <div class="key">h:m:s, y-m-d</div></th>
          <th class="diff">Diff  <div class="key">seconds</th>
          <th class="sender">Sender</th>
          <th class="host">Host</th>
          <th class="message">Message</th>
        </tr>
      </thead>
    </table>
  </nav>
  <article>
    <table id="Logs">
      <caption>Logs</caption>
      <colgroup>
        <col class="severity"/>
        <col class="time"/>
        <col class="diff"/>
        <col class="sender"/>
        <col class="host"/>
        <col class="message"/>
      </colgroup>
      <!--<thead>
        <tr>
          <th class="severity"></th>
          <th class="time">Time <div class="key">h:m:s, y-m-d</div></th>
          <th class="diff">Diff  <div class="key">seconds</th>
          <th class="sender">Sender</th>
          <th class="host">Host</th>
          <th class="message">Message</th>
        </tr>
      </thead>-->
      <tbody></tbody>
    </table>
  </article>
  <footer><span class="messages-count">Showing … messages</span></footer>
</body>
</html>
