<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <script type="text/javascript" src="EventEmitter2.js"></script>
  <script type="text/javascript" src="util.js"></script>
  <script type="text/javascript" src="array-proxy.js"></script>
  <script src="http://fb.me/react-0.12.2.js"></script>
  <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
  <script type="text/javascript">
(function() {
  function LogApp() {
  
    var _id = util.guid();
    var _messages = ArrayProxy.proxy([], messagesChangeHandler.bind(this)); // Private state
    var _maxWindowLength = 250;
    var _query = '';
    var _isListening = true;
    
    Object.defineProperty(this, 'id', {
      value: _id,
      enumerable: true,
      writable: false
    });
    
    Object.defineProperty(this, 'query', {
      get: function() { return _query; },
      set: function(q) {
        _query = q;
        this.emit('query:changed');
      },
      enumerable: true
    });
    
    Object.defineProperty(this, 'messages', {
      get: function() { return _messages; },
      set: function(ms) {
        if(!Array.isArray(ms)) { throw new TypeError('Must be an Array'); }
        _messages = ArrayProxy.proxy(
          truncateInPlace(ms, _maxWindowLength),
          messagesChangeHandler.bind(this)
        );
        //this.emit('messages:set', _messages);
        this.emit('messages:changed');
      },
      enumerable: true
    });
    
    function truncateInPlace(arr, maxLength, silent /* If true, subverts proxy to not fire change event */) {
      maxLength = maxLength || _maxWindowLength;
      silent = !!silent;
      // Call the Array.prototype version, not the proxy in silent mode
      var splice = silent ? Array.prototype.splice : arr.splice;
      // splice, unlike, slice modifies in-place
      splice.call(
        arr,
        maxLength, // start
        arr.length - (Math.min(maxLength, arr.length) - 1) // number to delete
      );
      return arr;        
    }
    
    Object.defineProperty(this, 'maxWindowLength', {
      get: function() { return _maxWindowLength; },
      set: function(value) {
        if('number' !== typeof value || value < 1) { throw new TypeError('maxWindowLength must be a non-zero, positive number'); }
        if(value < _maxWindowLength) {
          truncateInPlace(this.messages, value);
        }
        _maxWindowLength = value;
        this.emit('maxwindowlength:changed');
      },
      enumerable: true
    });
    
    function messagesChangeHandler(e, args) {
      console.log(e.type);
      truncateInPlace(_messages, _maxWindowLength, true);
      var messages = args;
      switch(e.type) {
        case 'push':
        case 'unshift': // unshift allows passing multiple arguments
          this.emit('messages:changed', Array.prototype.slice.call(arguments, 1));  // Arguments less the event
          break;
        case 'concat':
        case 'join':
        case 'slice': // None of these changes the array
          break;
        default:
          this.emit('messages:changed');
          break;
      }
    }
    
    Object.defineProperty(this, 'isListening', {
      get: function() { return _isListening; },
      set: function(value) {
        _isListening = value;
        this.emit('islistening:changed');
      },
      enumerable: true
    });
  }
  LogApp.prototype = Object.create(EventEmitter2.prototype);
  
  /****************************************/
  function LogController(model) {
    if(null === model || 'undefined' === typeof model) { throw new TypeError(); }
    
    this.model = model;
    this.eventSource = null;
    
    function messageChangeHandler(msgs) {
      renderMessages(this.model.messages);
    };
   
    model.on('messages:changed', messageChangeHandler.bind(this));

    function queryChangeHandler(query) {
      this.eventSource.close();
      this.initializeStream();
    }    
    model.on('query:changed', queryChangeHandler.bind(this));
  }
  // FIXME: This is mixing concerns
  LogController.prototype.initializeStream = function() {
    var url = '/stream/' + this.model.id + 
      (this.model.query ? '?q=' + encodeURIComponent(this.model.query) : '');
    //console.log(url);
    this.eventSource = new EventSource(url);
    
    var that = this;
    var source = this.eventSource;
    
    source.addEventListener('log', function(e) {
      var msg = JSON.parse(e.data);
      that.model.messages.unshift(msg);
    });

    source.addEventListener('batch', function(e) {
      var batch = JSON.parse(e.data);
      that.model.messages = batch;
    });

    source.addEventListener('open', function(e) {
      //console.dir(this);
      console.log('Listening on ' + this.url);
    });

    source.onerror = function(e) {
      console.dir(e);
      this.close();
    }
  }
  
  /****************************************/
  var model = new LogApp(); 
  window.model = model; // DEBUG
  console.log('New model with id ' + model.id);
  
  var controller = new LogController(model);
  
  // FIXME: Get a real UI framework to do the rendering. This is awful.
  
  function renderMessages(msgs) {
    var body = document.querySelector('table#Logs > tbody');
    var table = body.parentNode;
    table.removeChild(body);
    body = document.createElement('tbody');
    for(var i = 0; i < msgs.length; i++) {
      var msg = msgs[i];
      body.appendChild(renderRow(msg));
    }
    table.appendChild(body);
    
    function renderRow(msg) {
      var row = document.createElement('tr');
      var time = document.createElement('td'),
          host = document.createElement('td'),
          severity = document.createElement('td'),
          message = document.createElement('td');
      time.appendChild(document.createTextNode(msg.time));
      host.appendChild(document.createTextNode(msg.host));
      severity.appendChild(document.createTextNode(msg.severity));
      message.appendChild(document.createTextNode(msg.message));
      row.appendChild(time);
      row.appendChild(host);
      row.appendChild(severity);
      row.appendChild(message);
      return row;
    }
  }

  document.addEventListener('DOMContentLoaded', function(e) {
    controller.initializeStream();
    
    var form = document.querySelector('form#Search');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      model.query = form.querySelector('input').value;
    });
  }, false);
})();
  </script>
  <style type="text/css">
body {
  font-family: Helvetica, sans-serif;
  padding: 2em 1em;
}
table#Logs {
  width: 100%;
  border-collapse: collapse;
}
td, th {
  text-align: left;
  padding: 0.25rem 0.5rem;
  border: solid 1px #ccc;
}
  </style>
</head>
<body>
  <form id="Search">
    <input type="text" name="q"/>
    <button>Search</button>
  </form>
  <table id="Logs">
    <thead>
      <tr>
        <th>Time</th>
        <th>Host</th>
        <th>Severity</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
    
    </tbody>
  </table>
</body>
</html>
