<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Log Viewer</title>
  <script type="text/javascript" src="EventEmitter2.js"></script>
  <script type="text/javascript" src="util.js"></script>
  <script type="text/javascript" src="array-proxy.js"></script>
  <script src="http://fb.me/react-0.12.2.js"></script>
  <script src="http://fb.me/JSXTransformer-0.12.2.js"></script>
  <script type="text/javascript">
(function() {
  function LogApp() {
    var _id = util.guid();
    Object.defineProperty(this, 'id', {
      get: function() { return _id; },
      enumerable: true
    });
    
    
    var _query = ''; // Private state
    Object.defineProperty(this, 'query', {
      get: function() { return _query; },
      set: function(q) {
        _query = q;
        this.emit('query');
      },
      enumerable: true
    });
    
    var _messages = ArrayProxy.proxy([], messagesChangeHandler); // Private state
    function messagesChangeHandler(e) {
      console.log(e.type);
      this.emit('messages:' + e.type);
    }
    Object.defineProperty(this, 'messages', {
      get: function() { return _messages; },
      set: function(ms) {
        if(!Array.isArray(ms)) { throw new TypeError('Must be an Array'); }
        _messages = ArrayProxy.proxy(ms, messagesChangeHandler);
        this.emit('messages:set');
      },
      enumerable: true
    });
  }
  //LogApp.prototype = Object.clone(EventEmitter.prototype);
  LogApp.prototype = Object.create(EventEmitter2.prototype);
  LogApp.prototype.initializeStream = function(url) {
    var that = this;
    url = (url || '/stream/') + this.id;
    var source = new EventSource(url);

    source.addEventListener('log', function(e) {
      var msg = JSON.parse(e.data);
      //console.dir(msg);
      that.emit('log:received', msg);
    }, false);

    source.addEventListener('batch', function(e) {
      // console.log(e.data);
      var batch = JSON.parse(e.data);
      //console.dir(msg);
      that.emit('log:batch', batch);
    }, false);

    source.addEventListener('open', function(e) {
      console.log('Opened connection');
    }, false);

    source.onerror = function(e) {
      console.dir(e);
      this.close();
    }
  }
  LogApp.prototype.query = function(qs) {
    console.log(qs);
  }
  
  /****************************************/
  var app = new LogApp();
  console.log('New app with id ' + app.id);
  
  app.on('query', function() { console.log(this.query);});
  
  // FIXME: Get a real UI framework to do the rendering. This is awful.
  app.on('log:received', function(msg) {
    var body = document.querySelector('table#Logs > tbody');
    body.insertBefore(renderRow(msg), body.firstChild);
  });
  
  app.on('log:batch', function(msgs) {
    var body = document.querySelector('table#Logs > tbody');
    for(var i = 0; i < msgs.length; i++) {
      var msg = msgs[i];
      body.appendChild(renderRow(msg));
    }
  });
  
  function renderRow(msg) {
    var row = document.createElement('tr');
    var time = document.createElement('td'),
        host = document.createElement('td'),
        severity = document.createElement('td'),
        message = document.createElement('td');
    time.appendChild(document.createTextNode(msg.time));
    host.appendChild(document.createTextNode(msg.host));
    severity.appendChild(document.createTextNode(msg.severity));
    message.appendChild(document.createTextNode(msg.message));
    row.appendChild(time);
    row.appendChild(host);
    row.appendChild(severity);
    row.appendChild(message);
    return row;
  }

  document.addEventListener('DOMContentLoaded', function(e) {
    app.initializeStream();
    
    var form = document.querySelector('form#Search');
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      app.query = form.querySelector('input').value;
    });
  }, false);
})();
  </script>
  <style type="text/css">
body {
  font-family: Helvetica, sans-serif;
  padding: 2em 1em;
}
table#Logs {
  width: 100%;
  border-collapse: collapse;
}
td, th {
  text-align: left;
  padding: 0.25rem 0.5rem;
  border: solid 1px #ccc;
}
  </style>
</head>
<body>
  <form id="Search">
    <input type="text" name="q"/>
    <button>Search</button>
  </form>
  <table id="Logs">
    <thead>
      <tr>
        <th>Time</th>
        <th>Host</th>
        <th>Severity</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
    
    </tbody>
  </table>
</body>
</html>
